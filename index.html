<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–µ—Ç–ª—è—á–æ–∫ - –ó–∞–∫–∞–∑</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary-color: #007bff; --telegram-color: #0088cc; --bg-light: #f4f7f9; --text-dark: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-light); color: var(--text-dark); }
        .container { padding: 20px 5%; max-width: 500px; margin: 0 auto; }
        .product-card { background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: relative; }
        
        .custom-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
        .custom-input:read-only { background-color: #e9ecef; color: #6c757d; }
        
        .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 16px; margin-top: 10px;}
        .btn-telegram { background-color: var(--telegram-color); color: white; box-shadow: 0 4px 12px rgba(0,136,204,0.3); }
        .btn-outline { background: #fff; border: 2px dashed #cbd5e0; color: #718096; }
        
        #yandex-map { width: 100%; height: 400px; display: none; margin-top: 10px; border-radius: 12px; overflow: hidden; }
        
        .img-container { display: none; justify-content: center; margin-bottom: 20px; height: 200px; align-items: center; }
        .product-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; border-radius: 12px; }

        .version-tag {
            position: fixed; bottom: 5px; right: 10px; font-size: 12px; color: #aaa;
            background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 4px;
            z-index: 9999; pointer-events: none; font-family: monospace;
        }
    </style>
</head>
<body>

    <div id="version-display" class="version-tag">Checking...</div>
    <script>
        (function(){
            const params = new URLSearchParams(window.location.search);
            document.getElementById('version-display').innerText = 'v=' + (params.get('v') || 'dev');
        })();
    </script>

    <div class="container">
        <div class="product-card">
            <h2 style="text-align:center">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
            
            <div id="image-wrapper" class="img-container">
                <img id="img-mini" src="firefly_mini.png" class="product-img">
                <img id="img-std-black" src="firefly_std_black.png" class="product-img">
                <img id="img-std-white" src="firefly_std_white.png" class="product-img">
                <img id="img-std-gray"  src="firefly_std_gray.png"  class="product-img">
            </div>

            <label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</label>
            <select id="prod-type" class="custom-input">
                <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ --</option>
                <option value="Mini">–°–≤–µ—Ç–ª—è—á–æ–∫ –ú–∏–Ω–∏ (4500 ‚ÇΩ)</option>
                <option value="Standart">–°–≤–µ—Ç–ª—è—á–æ–∫ –°—Ç–∞–Ω–¥–∞—Ä—Ç (7500 ‚ÇΩ)</option>
            </select>

            <div id="color-block" style="display:none;">
                <label>–¶–≤–µ—Ç:</label>
                <select id="prod-color" class="custom-input">
                    <option value="Black">–ß–µ—Ä–Ω—ã–π</option>
                    <option value="White">–ë–µ–ª—ã–π</option>
                    <option value="Gray">–°–µ—Ä—ã–π</option>
                </select>
            </div>

            <label>–î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
            <input type="text" id="fio" class="custom-input" placeholder="–§–ò–û –ü–æ–ª—É—á–∞—Ç–µ–ª—è">
            <input type="tel" id="phone" class="custom-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7...)">

            <label>–ì–æ—Ä–æ–¥ –∏ –ü–í–ó:</label>
            <input type="text" id="city" class="custom-input" placeholder="–ì–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∑–∞–Ω—å)">
            
            <div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">
                –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø–æ–∏—Å–∫–∞:
            </div>
            <button type="button" class="btn btn-outline" id="open-map-btn">üìç –ù–∞–π—Ç–∏ –ø—É–Ω–∫—Ç –°–î–≠–ö</button>
            <div id="yandex-map"></div>
            <input type="text" id="cdek-address" class="custom-input" placeholder="–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞" readonly style="margin-top:10px;">

            <button id="submit-btn" class="btn btn-telegram" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <div id="status-msg" style="margin-top:15px; text-align:center;"></div>
        </div>
    </div>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=7b361d69-75a5-4bd0-b4a7-eb008bb4503f&lang=ru_RU" type="text/javascript"></script>

    <script>
        const tg = window.Telegram.WebApp; 
        tg.ready();
        tg.expand();

        // 1. –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('focus', function() { if (!this.value) this.value = '+7'; });
        phoneInput.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, ''); 
            if (value.length === 0) { this.value = ''; return; }
            if (value[0] === '8') value = '7' + value.substring(1);
            else if (value[0] === '9') value = '7' + value;
            else if (value[0] !== '7') value = '7' + value;
            if (value.length > 11) value = value.substring(0, 11);
            this.value = '+' + value;
        });

        // 2. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫
        const typeSelect = document.getElementById('prod-type');
        const colorSelect = document.getElementById('prod-color');
        
        function updateUI() {
            const type = typeSelect.value;
            const color = colorSelect.value;
            const imgWrap = document.getElementById('image-wrapper');
            const imgs = document.querySelectorAll('.product-img');
            
            imgs.forEach(i => i.style.display = 'none');
            
            if(!type) { imgWrap.style.display = 'none'; return; }
            
            imgWrap.style.display = 'flex';
            if(type === 'Mini') {
                document.getElementById('color-block').style.display = 'none';
                document.getElementById('img-mini').style.display = 'block';
            } else {
                document.getElementById('color-block').style.display = 'block';
                if(color === 'Black') document.getElementById('img-std-black').style.display = 'block';
                if(color === 'White') document.getElementById('img-std-white').style.display = 'block';
                if(color === 'Gray') document.getElementById('img-std-gray').style.display = 'block';
            }
        }
        typeSelect.addEventListener('change', updateUI);
        colorSelect.addEventListener('change', updateUI);

        // 3. –ö–∞—Ä—Ç—ã
        document.getElementById('open-map-btn').addEventListener('click', () => {
            const city = document.getElementById('city').value;
            if(!city) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥!");
            
            const mapDiv = document.getElementById('yandex-map');
            mapDiv.style.display = 'block';
            
            ymaps.ready(() => {
                const map = new ymaps.Map('yandex-map', { center: [55.75, 37.61], zoom: 9, controls: ['zoomControl'] });
                const search = new ymaps.control.SearchControl({ options: { provider: 'yandex#search', noPlacemark: false } });
                map.controls.add(search);
                
                search.events.add('resultselect', (e) => {
                    const idx = e.get('index');
                    search.getResult(idx).then(res => {
                        const name = res.properties.get('name');
                        const addr = res.properties.get('description') || res.properties.get('text');
                        document.getElementById('cdek-address').value = `${addr}, ${name}`;
                        
                        setTimeout(() => {
                            mapDiv.style.display = 'none';
                            document.getElementById('cdek-address').scrollIntoView({behavior: 'smooth'});
                        }, 1000);
                    });
                });
                search.search('–°–î–≠–ö ' + city);
            });
        });

        // 4. –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –í –¢–ï–õ–ï–ì–†–ê–ú
        function sendOrder() {
            const fio = document.getElementById('fio').value;
            const phone = document.getElementById('phone').value;
            const addr = document.getElementById('cdek-address').value;
            const prod = document.getElementById('prod-type').value;
            let color = document.getElementById('prod-color').value;
            
            // --- [v013 FIX] –ï—Å–ª–∏ –ú–∏–Ω–∏, —Ç–æ —Ü–≤–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ Black ---
            if (prod === 'Mini') color = 'Black';

            if(!fio || !phone || !addr || !prod) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

            // –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ–±—ä–µ–∫—Ç
            const data = {
                fio: fio,
                phone: phone,
                address: addr,
                product: prod,
                color: color
            };

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É (–ë–µ–∑–æ–ø–∞—Å–Ω–æ)
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>