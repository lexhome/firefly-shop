<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–µ—Ç–ª—è—á–æ–∫ - –ó–∞–∫–∞–∑</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary-color: #007bff; --telegram-color: #0088cc; --bg-light: #f4f7f9; --text-dark: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-light); color: var(--text-dark); }
        .container { padding: 20px 5%; max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
        .product-card { background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: relative; margin-bottom: 20px; }
        
        .custom-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
        .custom-input:read-only { background-color: #e9ecef; color: #6c757d; }
        
        .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 16px; margin-top: 10px;}
        .btn-telegram { background-color: var(--telegram-color); color: white; box-shadow: 0 4px 12px rgba(0,136,204,0.3); }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-outline { background: #fff; border: 2px dashed #cbd5e0; color: #718096; }
        
        #yandex-map { width: 100%; height: 400px; display: none; margin-top: 10px; border-radius: 12px; overflow: hidden; }
        
        .img-container { display: none; justify-content: center; margin-bottom: 20px; height: 200px; align-items: center; }
        .product-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; border-radius: 12px; }

        .cart-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-item-info { font-size: 14px; }
        .cart-item-price { font-weight: bold; }
        .btn-remove { background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; margin-left: 10px; font-size: 12px; }

        .total-block {
            background-color: #f0f9ff;
            border: 1px solid #bae3ff;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; color: #555; }
        .price-total { border-top: 1px solid #ddd; margin-top: 8px; padding-top: 8px; font-weight: bold; font-size: 18px; color: #000; display: flex; justify-content: space-between; }

        .delivery-options { display: flex; gap: 10px; margin-bottom: 15px; }
        .delivery-option {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .delivery-option.active {
            border-color: var(--telegram-color);
            background-color: #f0f9ff;
            color: var(--telegram-color);
            font-weight: bold;
        }
        .delivery-option span { display: block; font-size: 12px; color: #888; margin-top: 3px; }
        .delivery-option.active span { color: var(--telegram-color); }

        .version-tag {
            position: fixed; bottom: 5px; right: 10px; font-size: 12px; color: #aaa;
            background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 4px;
            z-index: 9999; pointer-events: none; font-family: monospace;
        }
    </style>
</head>
<body>

    <div id="version-display" class="version-tag">Checking...</div>
    <script>
        (function(){
            const params = new URLSearchParams(window.location.search);
            document.getElementById('version-display').innerText = 'v=' + (params.get('v') || 'dev');
        })();
    </script>

    <div class="container">
        
        <div class="product-card">
            <h2 style="text-align:center">–í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
            
            <div id="image-wrapper" class="img-container">
                <img id="img-mini" src="firefly_mini.png" class="product-img">
                <img id="img-std-black" src="firefly_std_black.png" class="product-img">
                <img id="img-std-white" src="firefly_std_white.png" class="product-img">
                <img id="img-std-gray"  src="firefly_std_gray.png"  class="product-img">
                <img id="img-std-blue"  src="firefly_std_blue.png"  class="product-img">
            </div>

            <label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</label>
            <select id="prod-type" class="custom-input">
                <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å --</option>
                <option value="Mini">–°–≤–µ—Ç–ª—è—á–æ–∫ –ú–∏–Ω–∏ (4500 ‚ÇΩ)</option>
                <option value="Standart">–°–≤–µ—Ç–ª—è—á–æ–∫ –°—Ç–∞–Ω–¥–∞—Ä—Ç (7500 ‚ÇΩ)</option>
            </select>

            <div id="color-block" style="display:none;">
                <label>–¶–≤–µ—Ç:</label>
                <select id="prod-color" class="custom-input">
                    <option value="Black">–ß–µ—Ä–Ω—ã–π</option>
                    <option value="White">–ë–µ–ª—ã–π</option>
                    <option value="Gray">–°–µ—Ä—ã–π</option>
                    <option value="Blue">–°–∏–Ω–∏–π</option>
                </select>
            </div>

            <button type="button" class="btn btn-secondary" onclick="addToCart()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>

        <div class="product-card" id="cart-card" style="display:none;">
            <h3 style="margin-top:0">üõí –ö–æ—Ä–∑–∏–Ω–∞</h3>
            <div id="cart-list"></div>
            
            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 20px 0;">

            <label>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
            <div class="delivery-options">
                <div class="delivery-option active" onclick="setDelivery('cdek')" id="opt-cdek">
                    –°–î–≠–ö
                    <span>450 ‚ÇΩ</span>
                </div>
                <div class="delivery-option" onclick="setDelivery('ozon')" id="opt-ozon">
                    OZON
                    <span>200 ‚ÇΩ</span>
                </div>
            </div>

            <label>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</label>
            <input type="text" id="fio" class="custom-input" placeholder="–§–ò–û">
            <input type="tel" id="phone" class="custom-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7...)">

            <label>–ì–æ—Ä–æ–¥ –∏ –ü–í–ó:</label>
            <input type="text" id="city" class="custom-input" placeholder="–ì–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∑–∞–Ω—å)">
            
            <button type="button" class="btn btn-outline" id="open-map-btn" style="margin-bottom:10px;">üìç –ù–∞–π—Ç–∏ –ø—É–Ω–∫—Ç –°–î–≠–ö</button>
            <div id="yandex-map"></div>
            <input type="text" id="cdek-address" class="custom-input" placeholder="–ê–¥—Ä–µ—Å –ø—É–Ω–∫—Ç–∞" readonly style="margin-top:10px;">

            <div id="total-block" class="total-block">
                <div class="price-row">
                    <span>–¢–æ–≤–∞—Ä—ã:</span>
                    <span id="price-device">0 ‚ÇΩ</span>
                </div>
                <div class="price-row">
                    <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                    <span id="price-delivery">450 ‚ÇΩ</span>
                </div>
                <div class="price-total">
                    <span>–ò–¢–û–ì–û:</span>
                    <span id="price-total">0 ‚ÇΩ</span>
                </div>
            </div>

            <button id="submit-btn" class="btn btn-telegram" onclick="sendOrder()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=7b361d69-75a5-4bd0-b4a7-eb008bb4503f&lang=ru_RU" type="text/javascript"></script>

    <script>
        const tg = window.Telegram.WebApp; 
        tg.ready();
        tg.expand();

        let currentDelivery = 'cdek';
        let cart = [];

        // 1. –ú–ê–°–ö–ê –¢–ï–õ–ï–§–û–ù–ê (–∏–∑ v016)
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('focus', function() { if (!this.value) this.value = '+7'; });
        phoneInput.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, ''); 
            if (value.length === 0) { this.value = ''; return; }
            if (value[0] === '8') value = '7' + value.substring(1);
            else if (value[0] !== '7') value = '7' + value;
            if (value.length > 11) value = value.substring(0, 11);
            this.value = '+' + value;
        });

        // 2. –ö–ê–†–¢–ò–ù–ö–ò (–∏–∑ v016 + –°–∏–Ω–∏–π)
        const typeSelect = document.getElementById('prod-type');
        const colorSelect = document.getElementById('prod-color');
        
        function updateUI() {
            const type = typeSelect.value;
            const color = colorSelect.value;
            const imgWrap = document.getElementById('image-wrapper');
            const imgs = document.querySelectorAll('.product-img');
            
            imgs.forEach(i => i.style.display = 'none');
            
            if(!type) { imgWrap.style.display = 'none'; return; }
            
            imgWrap.style.display = 'flex';
            if(type === 'Mini') {
                document.getElementById('color-block').style.display = 'none';
                document.getElementById('img-mini').style.display = 'block';
            } else {
                document.getElementById('color-block').style.display = 'block';
                if(color === 'Black') document.getElementById('img-std-black').style.display = 'block';
                if(color === 'White') document.getElementById('img-std-white').style.display = 'block';
                if(color === 'Gray') document.getElementById('img-std-gray').style.display = 'block';
                if(color === 'Blue') document.getElementById('img-std-blue').style.display = 'block';
            }
        }

        typeSelect.addEventListener('change', updateUI);
        colorSelect.addEventListener('change', updateUI);

        // 3. –ö–û–†–ó–ò–ù–ê
        function addToCart() {
            const type = typeSelect.value;
            if (!type) { tg.showPopup({message: "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!"}); return; }
            
            let color = 'Black'; 
            let price = 4500;
            
            if (type === 'Standart') {
                color = colorSelect.value;
                price = 7500;
            }

            const item = {
                id: Date.now(),
                type: type,
                color: color,
                price: price
            };

            cart.push(item);
            renderCart();
            tg.HapticFeedback.notificationOccurred('success');
            setTimeout(() => { document.getElementById('cart-card').scrollIntoView({behavior: 'smooth'}); }, 300);
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            renderCart();
        }

        function renderCart() {
            const cartList = document.getElementById('cart-list');
            const cartCard = document.getElementById('cart-card');
            
            if (cart.length === 0) {
                cartCard.style.display = 'none';
                return;
            } else {
                cartCard.style.display = 'block';
            }

            cartList.innerHTML = '';
            let goodsTotal = 0;

            cart.forEach(item => {
                goodsTotal += item.price;
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div class="cart-item-info">
                        <b>${item.type === 'Mini' ? '–°–≤–µ—Ç–ª—è—á–æ–∫ Mini' : '–°–≤–µ—Ç–ª—è—á–æ–∫ Std'}</b><br>
                        <span style="color:#666">–¶–≤–µ—Ç: ${item.type === 'Mini' ? '-' : item.color}</span>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <div class="cart-item-price">${item.price} ‚ÇΩ</div>
                        <button class="btn-remove" onclick="removeFromCart(${item.id})">√ó</button>
                    </div>
                `;
                cartList.appendChild(div);
            });

            calculateTotal(goodsTotal);
        }

        // 4. –î–û–°–¢–ê–í–ö–ê –∏ –ö–ê–†–¢–ê 
        function setDelivery(method) {
            currentDelivery = method;
            document.getElementById('opt-cdek').classList.remove('active');
            document.getElementById('opt-ozon').classList.remove('active');
            document.getElementById('opt-' + method).classList.add('active');

            const mapBtn = document.getElementById('open-map-btn');
            if(method === 'cdek') mapBtn.innerText = "üìç –ù–∞–π—Ç–∏ –ø—É–Ω–∫—Ç –°–î–≠–ö";
            if(method === 'ozon') mapBtn.innerText = "üìç –ù–∞–π—Ç–∏ –ø—É–Ω–∫—Ç Ozon";
            
            document.getElementById('cdek-address').value = "";
            document.getElementById('yandex-map').style.display = 'none';

            let goodsTotal = cart.reduce((sum, item) => sum + item.price, 0);
            calculateTotal(goodsTotal);
        }

        function calculateTotal(goodsSum) {
            let deliveryPrice = (currentDelivery === 'ozon') ? 200 : 450;
            const total = goodsSum + deliveryPrice;

            document.getElementById('price-device').innerText = goodsSum + ' ‚ÇΩ';
            document.getElementById('price-delivery').innerText = deliveryPrice + ' ‚ÇΩ';
            document.getElementById('price-total').innerText = total + ' ‚ÇΩ';
        }
        
        document.getElementById('open-map-btn').addEventListener('click', () => {
            const city = document.getElementById('city').value;
            if(!city) { tg.showPopup({message: "–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥!"}); return; }
            
            const mapDiv = document.getElementById('yandex-map');
            mapDiv.style.display = 'block';
            
            ymaps.ready(() => {
                // 1. –û–ß–ò–°–¢–ö–ê: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç—É (–∏—Å–ø–æ–ª—å–∑—É–µ–º window, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –Ω–∞–ª–æ–∂–µ–Ω–∏–π)
                if (window.myMap) {
                    window.myMap.destroy();
                    window.myMap = null;
                }
                document.getElementById('yandex-map').innerHTML = '';

                // 2. –°–û–ó–î–ê–ù–ò–ï: –ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞
                window.myMap = new ymaps.Map('yandex-map', { center: [55.75, 37.61], zoom: 10, controls: ['zoomControl'] });
                
                const search = new ymaps.control.SearchControl({ 
                    options: { 
                        provider: 'yandex#search', 
                        noPlacemark: false,
                        resultsPerPage: 5,
                        useMapBounds: false 
                    } 
                });
                window.myMap.controls.add(search);
                
                search.events.add('resultselect', (e) => {
                    const idx = e.get('index');
                    search.getResult(idx).then(res => {
                        const name = res.properties.get('name');
                        const addr = res.properties.get('description') || res.properties.get('text');
                        
                        document.getElementById('cdek-address').value = `${addr}, ${name}`;
                        
                        setTimeout(() => {
                            mapDiv.style.display = 'none';
                            // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–∞–º—è—Ç—å
                            if (window.myMap) {
                                window.myMap.destroy();
                                window.myMap = null;
                            }
                            document.getElementById('cdek-address').scrollIntoView({behavior: 'smooth'});
                        }, 1000);
                    });
                });

                // 3. –ü–û–ò–°–ö (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
                const method = (currentDelivery === 'ozon') ? 'Ozon' : '–°–î–≠–ö';
                
                // –°—Ç–∞–≤–∏–º –ì–û–†–û–î –ø–µ—Ä–≤—ã–º. –Ø–Ω–¥–µ–∫—Å —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–µ—Ç –≥–æ—Ä–æ–¥, –∞ –ø–æ—Ç–æ–º –ø—É–Ω–∫—Ç –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ.
                // –§–æ—Ä–º–∞—Ç: "–ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫ –°–î–≠–ö" –∏–ª–∏ "Novokuznetsk Ozon"
                search.search(city + ' ' + method);
            });
        });

        // 5. –û–¢–ü–†–ê–í–ö–ê
        function sendOrder() {
            if (cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");

            const fio = document.getElementById('fio').value;
            const phone = document.getElementById('phone').value;
            const city = document.getElementById('city').value;
            const addr = document.getElementById('cdek-address').value;

            if(!fio || !phone || !city || !addr) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏!");

            const data = {
                cart: cart,
                fio: fio,
                phone: phone,
                city: city, 
                address: addr,
                delivery_method: currentDelivery
            };

            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>