<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–µ—Ç–ª—è—á–æ–∫ - –ó–∞–∫–∞–∑</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary-color: #007bff; --telegram-color: #0088cc; --bg-light: #f4f7f9; --text-dark: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-light); color: var(--text-dark); }
        .container { padding: 20px 5%; max-width: 500px; margin: 0 auto; }
        .product-card { background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .custom-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
        .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 16px; margin-top: 10px;}
        .btn-telegram { background-color: var(--telegram-color); color: white; }
        .btn-outline { background: #fff; border: 2px dashed #cbd5e0; color: #718096; }
        #yandex-map { width: 100%; height: 400px; display: none; margin-top: 10px; border-radius: 12px; }
        .img-container { display: none; justify-content: center; margin-bottom: 20px; height: 200px; }
        .product-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="product-card">
            <h2 style="text-align:center">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
            
            <div id="image-wrapper" class="img-container">
                <img id="img-mini" src="firefly_mini.png" class="product-img">
                <img id="img-std-black" src="firefly_std_black.png" class="product-img">
                <img id="img-std-white" src="firefly_std_white.png" class="product-img">
                <img id="img-std-gray"  src="firefly_std_gray.png"  class="product-img">
            </div>

            <select id="prod-type" class="custom-input">
                <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ --</option>
                <option value="Mini">–°–≤–µ—Ç–ª—è—á–æ–∫ –ú–∏–Ω–∏ (4500 ‚ÇΩ)</option>
                <option value="Standart">–°–≤–µ—Ç–ª—è—á–æ–∫ –°—Ç–∞–Ω–¥–∞—Ä—Ç (7500 ‚ÇΩ)</option>
            </select>

            <div id="color-block" style="display:none;">
                <select id="prod-color" class="custom-input">
                    <option value="Black">–ß–µ—Ä–Ω—ã–π</option>
                    <option value="White">–ë–µ–ª—ã–π</option>
                    <option value="Gray">–°–µ—Ä—ã–π</option>
                </select>
            </div>

            <input type="text" id="tg-nick" class="custom-input" placeholder="–ù–∏–∫–Ω–µ–π–º" readonly>
            <input type="text" id="fio" class="custom-input" placeholder="–§–ò–û –ü–æ–ª—É—á–∞—Ç–µ–ª—è">
            <input type="tel" id="phone" class="custom-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7...)">
            <input type="text" id="city" class="custom-input" placeholder="–ì–æ—Ä–æ–¥">
            
            <button type="button" class="btn btn-outline" id="open-map-btn">üìç –ù–∞–π—Ç–∏ –ø—É–Ω–∫—Ç—ã –°–î–≠–ö</button>
            <div id="yandex-map"></div>
            <input type="text" id="cdek-address" class="custom-input" placeholder="–ê–¥—Ä–µ—Å –ü–í–ó" readonly style="margin-top:10px;">

            <button id="submit-btn" class="btn btn-telegram" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <div id="status-msg" style="margin-top:15px; text-align:center;"></div>
        </div>
    </div>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=7b361d69-75a5-4bd0-b4a7-eb008bb4503f&lang=ru_RU" type="text/javascript"></script>
    <script>
        const tg = window.Telegram.WebApp; 
        tg.expand();

        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        const BOT_TOKEN = '8558603580:AAG9cYrj7HA7XHz758HOj27cfElny1rfH2k'; 
        const ADMIN_ID = '483498099'; 
        // -----------------

        let userId = 0;
        let username = '';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userId = tg.initDataUnsafe.user.id;
                username = tg.initDataUnsafe.user.username || 'NoNick';
                document.getElementById('tg-nick').value = '@' + username;
            } else {
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ –∏–ª–∏ –≥–ª—é–∫ - –¥–∞–µ–º –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é
                document.getElementById('tg-nick').removeAttribute('readonly');
            }
        };

        // –õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ —Ü–≤–µ—Ç–∞)
        const typeSelect = document.getElementById('prod-type');
        const colorSelect = document.getElementById('prod-color');
        
        function updateUI() {
            const type = typeSelect.value;
            const color = colorSelect.value;
            const imgWrap = document.getElementById('image-wrapper');
            const imgs = document.querySelectorAll('.product-img');
            
            imgs.forEach(i => i.style.display = 'none');
            
            if(!type) { imgWrap.style.display = 'none'; return; }
            
            imgWrap.style.display = 'flex';
            if(type === 'Mini') {
                document.getElementById('color-block').style.display = 'none';
                document.getElementById('img-mini').style.display = 'block';
            } else {
                document.getElementById('color-block').style.display = 'block';
                if(color === 'Black') document.getElementById('img-std-black').style.display = 'block';
                if(color === 'White') document.getElementById('img-std-white').style.display = 'block';
                if(color === 'Gray') document.getElementById('img-std-gray').style.display = 'block';
            }
        }
        typeSelect.addEventListener('change', updateUI);
        colorSelect.addEventListener('change', updateUI);

        // –ö–∞—Ä—Ç—ã (—Å–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
        document.getElementById('open-map-btn').addEventListener('click', () => {
            const city = document.getElementById('city').value;
            if(!city) return alert("–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥!");
            document.getElementById('yandex-map').style.display = 'block';
            ymaps.ready(() => {
                const map = new ymaps.Map('yandex-map', { center: [55.75, 37.61], zoom: 9, controls: ['zoomControl'] });
                const search = new ymaps.control.SearchControl({ options: { provider: 'yandex#search' } });
                map.controls.add(search);
                search.events.add('resultselect', (e) => {
                    const idx = e.get('index');
                    search.getResult(idx).then(res => {
                        const name = res.properties.get('name');
                        const addr = res.properties.get('description');
                        document.getElementById('cdek-address').value = addr + ', ' + name;
                        document.getElementById('yandex-map').style.display = 'none';
                    });
                });
                search.search('–°–î–≠–ö ' + city);
            });
        });

        // –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê
        async function sendOrder() {
            const btn = document.getElementById('submit-btn');
            const status = document.getElementById('status-msg');
            
            const fio = document.getElementById('fio').value;
            const phone = document.getElementById('phone').value;
            const addr = document.getElementById('cdek-address').value;
            const prod = document.getElementById('prod-type').value;
            let color = document.getElementById('prod-color').value;
            if (prod === 'Mini') color = 'Standart'; // –î–ª—è –º–∏–Ω–∏ —Ü–≤–µ—Ç –Ω–µ –≤–∞–∂–µ–Ω

            if(!fio || !phone || !addr || !prod) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

            btn.disabled = true;
            status.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";

            // 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ê–¥–º–∏–Ω–∞
            // –í–ù–ò–ú–ê–ù–ò–ï: –í –∫–æ–Ω—Ü–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É /save_ID_Product
            // –ê–¥–º–∏–Ω –Ω–∞–∂–º–µ—Ç –Ω–∞ –Ω–µ—ë –≤ —á–∞—Ç–µ, –∏ –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∑–∞–∫–∞–∑.
            const productCode = prod + '_' + color;
            const saveCommand = `/save__${userId}__${productCode}`;
            
            const msg = `üõç <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó</b>\n\n` +
                        `üë§ <b>${fio}</b> (@${username})\n` +
                        `üìû ${phone}\n` +
                        `üì¶ ${prod} (${color})\n` +
                        `üìç ${addr}\n\n` +
                        `üëá <b>–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É:</b>\n` +
                        `${saveCommand}`;

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ FETCH (–ù–∞–¥–µ–∂–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ)
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: ADMIN_ID,
                        text: msg,
                        parse_mode: 'HTML'
                    })
                });

                // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É (–µ—Å–ª–∏ –µ—Å—Ç—å ID)
                if(userId) {
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            chat_id: userId,
                            text: "‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è.",
                            parse_mode: 'HTML'
                        })
                    });
                }

                status.innerHTML = "‚úÖ –£—Å–ø–µ—à–Ω–æ! –ó–∞–∫—Ä—ã–≤–∞–µ–º...";
                setTimeout(() => tg.close(), 2000);

            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ù–æ –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤—Ä—É—á–Ω—É—é.");
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>