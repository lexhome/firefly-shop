<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–µ—Ç–ª—è—á–æ–∫ - –ó–∞–∫–∞–∑</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root { --primary-color: #007bff; --telegram-color: #0088cc; --bg-light: #f4f7f9; --text-dark: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-light); color: var(--text-dark); }
        .container { padding: 20px 5%; max-width: 500px; margin: 0 auto; }
        .product-card { background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: relative; z-index: 1; }
        
        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø --- */
        .img-container {
            width: 100%;
            display: none; /* –°–ö–†–´–¢–û –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ */
            justify-content: center;
            margin-bottom: 20px;
            height: 200px; 
            align-items: center;
        }
        
        .product-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
            display: none; /* –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        .custom-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
        .custom-input:read-only { background-color: #e9ecef; color: #6c757d; border-color: #dee2e6; cursor: not-allowed; }

        .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 16px; margin-top: 10px;}
        .btn-telegram { background-color: var(--telegram-color); color: white; box-shadow: 0 4px 12px rgba(0,136,204,0.3); }
        .btn-outline { background: #fff; border: 2px dashed #cbd5e0; color: #718096; }
        
        #yandex-map { width: 100%; height: 400px; display: none; margin-top: 10px; border: 1px solid #ccc; border-radius: 12px; overflow: hidden; }
        #status-msg { margin-top: 15px; text-align: center; }
        .helper-text { font-size: 0.85rem; color: #666; margin-bottom: 10px; }

        /* --- –°–¢–ò–õ–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 90%; max-width: 400px;
            padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: left;
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .modal-content { font-size: 0.95rem; line-height: 1.5; color: #333; margin-bottom: 20px; white-space: pre-wrap; }
        .modal-question { font-weight: bold; text-align: center; margin-bottom: 20px; color: var(--primary-color); }
        .modal-buttons { display: flex; gap: 10px; }
        .btn-no { background: #e2e8f0; color: #333; flex: 1; }
        .btn-yes { background: #28a745; color: white; flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="product-card">
            <h2 style="text-align:center">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
            
            <div id="image-wrapper" class="img-container">
                <img id="img-mini" src="firefly_mini.png" alt="–°–≤–µ—Ç–ª—è—á–æ–∫ –ú–∏–Ω–∏" class="product-img">
                
                <img id="img-std-black" src="firefly_std_black.png" alt="–°—Ç–∞–Ω–¥–∞—Ä—Ç –ß–µ—Ä–Ω—ã–π" class="product-img">
                <img id="img-std-white" src="firefly_std_white.png" alt="–°—Ç–∞–Ω–¥–∞—Ä—Ç –ë–µ–ª—ã–π" class="product-img">
                <img id="img-std-gray"  src="firefly_std_gray.png"  alt="–°—Ç–∞–Ω–¥–∞—Ä—Ç –°–µ—Ä—ã–π"  class="product-img">
            </div>
            
            <label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</label>
            <select id="prod-type" class="custom-input">
                <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ --</option>
                <option value="–°–≤–µ—Ç–ª—è—á–æ–∫ –ú–∏–Ω–∏ (4500 ‚ÇΩ)">–°–≤–µ—Ç–ª—è—á–æ–∫ –ú–∏–Ω–∏ ‚Äî 4 500 ‚ÇΩ</option>
                <option value="–°–≤–µ—Ç–ª—è—á–æ–∫ –°—Ç–∞–Ω–¥–∞—Ä—Ç (7500 ‚ÇΩ)">–°–≤–µ—Ç–ª—è—á–æ–∫ –°—Ç–∞–Ω–¥–∞—Ä—Ç ‚Äî 7 500 ‚ÇΩ</option>
            </select>
            
            <div id="color-block" style="display:none;">
                <label>–¶–≤–µ—Ç:</label>
                <select id="prod-color" class="custom-input">
                    <option value="–ß–µ—Ä–Ω—ã–π">–ß–µ—Ä–Ω—ã–π</option>
                    <option value="–ë–µ–ª—ã–π">–ë–µ–ª—ã–π</option>
                    <option value="–°–µ—Ä—ã–π">–°–µ—Ä—ã–π</option>
                </select>
            </div>

            <label>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:</label>
            <input type="text" id="tg-nick" class="custom-input" placeholder="Telegram –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" readonly>
            
            <input type="text" id="fio" class="custom-input" placeholder="–§–ò–û –ü–æ–ª—É—á–∞—Ç–µ–ª—è">
            <input type="tel" id="phone" class="custom-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7...)">

            <label>–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
            <input type="text" id="city" class="custom-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∑–∞–Ω—å)">
            
            <label>–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –°–î–≠–ö:</label>
            <div class="helper-text">–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—ã—à–µ, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ.</div>
            
            <button type="button" class="btn btn-outline" id="open-map-btn">üìç –ù–∞–π—Ç–∏ –ø—É–Ω–∫—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ</button>
            
            <div id="yandex-map"></div>
            
            <input type="text" id="cdek-address" class="custom-input" placeholder="–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞" readonly style="margin-top:10px;">

            <button id="pre-submit-btn" class="btn btn-telegram" onclick="showConfirmation()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <div id="status-msg"></div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</div>
            <div id="modal-text" class="modal-content"></div>
            <div class="modal-question">–î–∞–Ω–Ω—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤–µ—Ä–Ω–æ?</div>
            <div class="modal-buttons">
                <button class="btn btn-no" onclick="closeModal()">–ù–µ—Ç, –∏—Å–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn btn-yes" id="final-send-btn" onclick="sendOrder()">–î–∞, –≤—Å—ë –≤–µ—Ä–Ω–æ</button>
            </div>
        </div>
    </div>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=7b361d69-75a5-4bd0-b4a7-eb008bb4503f&lang=ru_RU" type="text/javascript"></script>

    <script>
        const tg = window.Telegram.WebApp; 
        tg.expand();

        const BOT_TOKEN = '8558603580:AAG9cYrj7HA7XHz758HOj27cfElny1rfH2k'; 
        const CHAT_ID = '483498099'; 

        let userTelegramId = null;
        let userUsername = null;

        window.onload = () => {
            const nickInput = document.getElementById('tg-nick');
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                userTelegramId = u.id;
                userUsername = u.username;
                nickInput.value = u.username ? '@' + u.username : `${u.first_name} (ID: ${u.id})`;
                nickInput.setAttribute('readonly', true);
            } else {
                nickInput.removeAttribute('readonly');
                nickInput.placeholder = "–í–≤–µ–¥–∏—Ç–µ @username –≤—Ä—É—á–Ω—É—é";
            }
        };

        // --- –ï–î–ò–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        function updateInterface() {
            const type = document.getElementById('prod-type').value;
            const color = document.getElementById('prod-color').value;
            
            const imgContainer = document.getElementById('image-wrapper');
            const colorBlock = document.getElementById('color-block');

            // –ö–∞—Ä—Ç–∏–Ω–∫–∏
            const imgMini = document.getElementById('img-mini');
            const imgBlack = document.getElementById('img-std-black');
            const imgWhite = document.getElementById('img-std-white');
            const imgGray = document.getElementById('img-std-gray');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë –ø–µ—Ä–µ–¥ –ª–æ–≥–∏–∫–æ–π
            const allImages = [imgMini, imgBlack, imgWhite, imgGray];
            allImages.forEach(img => img.style.display = 'none');

            // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω - —Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –∏ –≤—ã—Ö–æ–¥–∏–º
            if (!type) {
                imgContainer.style.display = 'none';
                colorBlock.style.display = 'none';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            imgContainer.style.display = 'flex';

            if (type.includes('–°–≤–µ—Ç–ª—è—á–æ–∫ –°—Ç–∞–Ω–¥–∞—Ä—Ç')) {
                // –≠—Ç–æ –°–¢–ê–ù–î–ê–†–¢
                colorBlock.style.display = 'block';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–≤–µ—Ç–∞
                if (color === '–ß–µ—Ä–Ω—ã–π') imgBlack.style.display = 'block';
                else if (color === '–ë–µ–ª—ã–π') imgWhite.style.display = 'block';
                else if (color === '–°–µ—Ä—ã–π') imgGray.style.display = 'block';

            } else {
                // –≠—Ç–æ –ú–ò–ù–ò
                colorBlock.style.display = 'none';
                imgMini.style.display = 'block';
            }
        }

        // –í–µ—à–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('prod-type').addEventListener('change', updateInterface);
        document.getElementById('prod-color').addEventListener('change', updateInterface);


        // --- –õ–û–ì–ò–ö–ê –ö–ê–†–¢ ---
        let myMap = null;
        let searchControl = null;

        document.getElementById('open-map-btn').addEventListener('click', function() {
            const mapDiv = document.getElementById('yandex-map');
            const btn = this;
            const cityValue = document.getElementById('city').value.trim();

            if (!cityValue) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ –ø–æ–ª–µ '–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏'!");
                document.getElementById('city').focus();
                return;
            }

            mapDiv.style.display = 'block';
            btn.innerText = "‚è≥ –ò—â–µ–º –ø—É–Ω–∫—Ç—ã –°–î–≠–ö...";

            ymaps.ready(function () {
                if (!myMap) {
                    myMap = new ymaps.Map('yandex-map', {
                        center: [55.751574, 37.573856], zoom: 10, controls: ['zoomControl', 'geolocationControl']
                    });
                    searchControl = new ymaps.control.SearchControl({ options: { provider: 'yandex#search', noPlacemark: false, resultsPerPage: 10 } });
                    myMap.controls.add(searchControl);
                    searchControl.events.add('resultselect', function (e) {
                        const index = e.get('index');
                        searchControl.getResult(index).then(function (res) {
                            const name = res.properties.get('name'); 
                            const address = res.properties.get('description') || res.properties.get('text');
                            document.getElementById('cdek-address').value = `${address}, ${name}`;
                            setTimeout(() => {
                                mapDiv.style.display = 'none';
                                btn.innerText = "üìç –ò–∑–º–µ–Ω–∏—Ç—å –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏";
                                document.getElementById('cdek-address').scrollIntoView({behavior: 'smooth'});
                            }, 800);
                        });
                    });
                }
                searchControl.search(`–°–î–≠–ö ${cityValue}`).then(function () {
                    btn.innerText = "üìç –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ";
                    if (searchControl.getResultsCount() === 0) alert("–ü—É–Ω–∫—Ç—ã –°–î–≠–ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.");
                });
            });
        });

        document.getElementById('cdek-address').addEventListener('click', function() {
            if(this.hasAttribute('readonly') && confirm('–í–≤–µ—Å—Ç–∏ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é?')) {
                this.removeAttribute('readonly');
                this.focus();
            }
        });

        function getData() {
            return {
                prod: document.getElementById('prod-type').value,
                color: document.getElementById('prod-color').value,
                fio: document.getElementById('fio').value,
                city: document.getElementById('city').value,
                phone: document.getElementById('phone').value,
                addr: document.getElementById('cdek-address').value
            };
        }

        function showConfirmation() {
            const data = getData();
            
            // –ü–†–û–í–ï–†–ö–ê –ù–ê –í–´–ë–û–† –£–°–¢–†–û–ô–°–¢–í–ê
            if(!data.prod) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!");
                document.getElementById('prod-type').focus();
                return;
            }

            if(!data.fio || !data.phone || !data.addr || !data.city) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π!"); 
                return;
            }

            const previewText = 
                `üì¶ <b>–¢–æ–≤–∞—Ä:</b> ${data.prod}\n` +
                `üé® <b>–¶–≤–µ—Ç:</b> ${data.color}\n\n` +
                `üë§ <b>–§–ò–û:</b> ${data.fio}\n` +
                `üèô <b>–ì–æ—Ä–æ–¥:</b> ${data.city}\n` +
                `üì± <b>–¢–µ–ª:</b> ${data.phone}\n` +
                `üìç <b>–ü–í–ó:</b> ${data.addr}`;

            document.getElementById('modal-text').innerHTML = previewText;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }

        async function sendOrder() {
            closeModal();
            const btn = document.getElementById('pre-submit-btn');
            const status = document.getElementById('status-msg');
            const data = getData(); 

            let userLink = "";
            let displayNick = "";
            if (userUsername) {
                userLink = `https://t.me/${userUsername}`;
                displayNick = `<a href="${userLink}">@${userUsername}</a>`;
            } else if (userTelegramId) {
                userLink = `tg://user?id=${userTelegramId}`;
                displayNick = `<a href="${userLink}">–ü—Ä–æ—Ñ–∏–ª—å (ID: ${userTelegramId})</a>`;
            } else {
                displayNick = document.getElementById('tg-nick').value || "–ù–µ —É–∫–∞–∑–∞–Ω";
            }

            const adminMsg = `üõç <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó</b>\n\n` +
                             `üì¶ <b>–¢–æ–≤–∞—Ä:</b> ${data.prod}\n` +
                             `üé® <b>–¶–≤–µ—Ç:</b> ${data.color}\n\n` +
                             `üë§ <b>–§–ò–û:</b> ${data.fio}\n` +
                             `üèô <b>–ì–æ—Ä–æ–¥:</b> ${data.city}\n` +
                             `üì± <b>–¢–µ–ª:</b> ${data.phone}\n` +
                             `üìç <b>–ü–í–ó:</b> ${data.addr}\n` +
                             `üîó <b>–ö–ª–∏–µ–Ω—Ç:</b> ${displayNick}`;

            const userMsg = `‚úÖ <b>–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</b>\n\n` +
                            `üì¶ ${data.prod}\n` +
                            `üìç ${data.addr}\n\n` +
                            `–î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –º–µ–Ω–µ–¥–∂–µ—Ä—É. –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.`;

            btn.disabled = true;
            status.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";

            try {
                const adminResponse = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ chat_id: CHAT_ID, text: adminMsg, parse_mode: 'HTML' })
                });

                if (!adminResponse.ok) throw new Error('–û—à–∏–±–∫–∞ Telegram API');

                if (userTelegramId) {
                    try {
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST', headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ chat_id: userTelegramId, text: userMsg, parse_mode: 'HTML' })
                        });
                    } catch (err) { console.log("–ë–æ—Ç –Ω–µ —Å–º–æ–≥ –Ω–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É"); }
                }

                status.innerHTML = "<span style='color:#28a745'>‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</span>";
                setTimeout(() => tg.close(), 3000);

            } catch(e) {
                window.open(`https://t.me/leks_k7?text=${encodeURIComponent(adminMsg.replace(/<[^>]*>/g, ''))}`);
                status.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç...";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>